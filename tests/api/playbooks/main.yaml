---
# use an ansible playbook to automate endpoint testing

- name: Masterbomb API Integration Testing
  hosts: localhost
  vars_files:
    - all.yaml
  become: false

  pre_tasks:
    # use wait_for to validate github servers can be reached from the target node
    - name: Validate connection to the api 
      wait_for:
        host: "{{ api_base_url }}"
        timeout: 10
        active_connection_states: ESTABLISHED

  tasks:
    # test each subset of endpoints in stages
    # 1. add a supplier
    # 2. get all suppliers
    # 3. delete added supplier
    - name: Test /suppliers/add
      uri:
        url: "{{ api_base_url }}/suppliers/add"
        method: POST 
        headers:
          accept: application/json
        status_code: "{{ post_status }}"
        body:
          name: Test Supplier Name
          website: www.test-supplier.com
        body_format: json
      register: post_response

    - name: Test /suppliers/get/:id
      uri:
        url: "{{ api_base_url }}/suppliers/get/{{ post_response.json.id.id }}"
        method: GET 
        headers:
          accept: application/json
        status_code: "{{ get_status }}"
    
    - name: Test /suppliers/all
      uri:
        url: "{{ api_base_url }}/suppliers/all"
        method: GET 
        headers:
          accept: application/json
        status_code: "{{ get_status }}"

    - name: Test /suppliers/delete/:id
      uri:
        url: "{{ api_base_url }}/suppliers/delete/{{ post_response.json.id.id }}"
        method: DELETE 
        headers:
          accept: application/json
        status_code: "{{ delete_status }}" 