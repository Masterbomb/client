---
# use an ansible playbook to automate endpoint testing

- name: Masterbomb API Integration Testing
  hosts: localhost
  vars_files:
    - all.yaml
  become: false

  pre_tasks:
    # use wait_for to validate github servers can be reached from the target node
    - name: Validate connection to the api 
      wait_for:
        host: "{{ api_base_url }}"
        timeout: 10
        active_connection_states: ESTABLISHED

  tasks:
    # test each subset of endpoints in stages
    # 1. add a supplier
    # 2. get all suppliers
    # 3. delete added supplier
    - name: Test POST endpoints
      uri:
        url: "{{ api_base_url }}{{ item.value.path }}"
        method: POST 
        headers:
          accept: application/json
        status_code: "{{ item.value.status }}" 
        body: "{{ item.value.data }}"
        body_format: json
      loop: "{{ q('dict', api_endpoints['POST']) }}"
    
    - name: Test GET endpoints
      uri:
        url: "{{ api_base_url }}{{ item.value.path }}"
        method: GET 
        headers:
          accept: application/json
        status_code: "{{ item.value.status }}" 
      loop: "{{ q('dict', api_endpoints['GET']) }}"
    
    - name: Test DELETE endpoints
      uri:
        url: "{{ api_base_url }}{{ item.value.path }}"
        method: DELETE 
        headers:
          accept: application/json
        status_code: "{{ item.value.status }}" 
      loop: "{{ q('dict', api_endpoints['DELETE']) }}"
    